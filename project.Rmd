---
title: "cherryB"
author: "Mina Mehdinia, Justin Valentine, Michael Wells"
date: "2022-10-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rvest)
library(stringr)
library(tidyverse)
library(lubridate)
library(dplyr)
library(ggplot2)
#install.packages("plotly")
#devtools::install_github("dtkaplan/statisticalModeling")
#library(devtools)
library(statisticalModeling)
library(olsrr)
library(scatterplot3d)
library(plotly)
```

```{r}
Wdata <-  read.csv("newdata.csv")
Mdata <- read.csv("mendataclean.csv")
```

```{r}
Wdat = Wdata[(!is.na(Wdata$Age))&(!is.na(Wdata$Time)),] #removing NA in Age and Time observation
Wdat <- Wdat %>% filter(Time != "") #removing unrecorded values
Wdat <- Wdat %>% filter(Time != "NR" & Age !="NR") #removing NR
Wdat <- add_rownames(Wdat) #necessary for indexing
```

```{r}
Mdat = Mdata[(!is.na(Mdata$Age))&(!is.na(Mdata$Time)),] #removing NA in Age and Time observation
Mdat <- Mdat %>% filter(Time != "") #removing unrecorded values
Mdat <- Mdat %>% filter(Time != "NR" & Age !="NR") #removing NR
Mdat <- add_rownames(Mdat) #necessary for indexing

#Mdat %>% filter(Time == "0.069664352")
#rows 4733 6623 105561  have crazy decimals
#times of "0.044872685"   "0.047581019"   "0.069664352"
Mdat <- Mdat[-c(4733,6623,105561),] 
```


```{r}
#Need to remove all the times starting with a 3 because they are either recorded in error
#i.e. time of 36:47:00 or beyond the limit of 2h20m
rowname_3s_W <- Wdat %>% 
   filter(str_detect(Time, "^3")) %>% select(rowname)
rowname_3s_W <- as.numeric(rowname_3s_W$rowname)
Wdat <- Wdat[-c(rowname_3s_W),]
```

```{r}
#Need to remove all the times starting with a 3 because they are either recorded in error
#i.e. time of 36:47:00 or beyond the limit of 2h20m
rowname_3s_M <- Mdat %>% 
   filter(str_detect(Time, "^3")) %>% select(rowname)

rowname_3s_M <- as.numeric(rowname_3s_M$rowname)

Mdat <- Mdat[!Mdat$rowname%in%rowname_3s_M,] #For some reason the other method used in Wdat didn't work here. 
```


```{r}
#Find all the times that are in the format of M:S:00 and change class to Time
#This is necessary otherwise they will be recorded as a race time of >50 hours etc
starts_5 <- Wdat %>% 
   filter(str_detect(Time, "^5")) %>% select(Time,rowname) 
starts_5$Time <- starts_5$Time %>% str_extract(pattern = "^\\d{2}:\\d{2}") %>% ms()

starts_4 <- Wdat %>% 
   filter(str_detect(Time, "^4")) %>% select(Time,rowname) 
starts_4$Time <- starts_4$Time %>% str_extract(pattern = "^\\d{2}:\\d{2}") %>% ms()
```

```{r}
#The majority of times are recorded as H M S but are still class Char
test_1 <- Wdat %>% #starts with 0
   filter(str_detect(Time, "^0")) %>% select(Time,rowname) 
test_2 <- Wdat %>% #starts with 1
   filter(str_detect(Time, "^1")) %>% select(Time,rowname) 
test_3 <- Wdat %>% #starts with 2
   filter(str_detect(Time, "^2")) %>% select(Time,rowname) 
test_complete <- rbind(test_1,test_2,test_3)
test_complete$Time <- test_complete$Time %>% str_extract(pattern = "^\\d{1}:\\d{2}:\\d{2}") %>%  #\d match any char with cat. number decimal digit
  hms()
test_complete <- rbind(test_complete,starts_5,starts_4)

test_complete
```

```{r}
#Join all of these together. Note the new column is Time.y
Wdat <- left_join(Wdat,test_complete, by="rowname")
Wdat
```

```{r}
#Change time to minutes
Wdat$Time.y <- period_to_seconds(Wdat$Time.y)/60
Wdat
```

The women's times are cleaned, below we will clean the men's times.

```{r}
#Find all the times that are in the format of M:S:00 and change class to Time
#This is necessary otherwise they will be recorded as a race time of >50 hours etc
starts_5_M <- Mdat %>% 
   filter(str_detect(Time, "^5")) %>% select(Time,rowname) 
starts_5_M$Time <- starts_5_M$Time %>% str_extract(pattern = "^\\d{2}:\\d{2}") %>% ms()

starts_4_M <- Mdat %>% 
   filter(str_detect(Time, "^4")) %>% select(Time,rowname) 
starts_4_M$Time <- starts_4_M$Time %>% str_extract(pattern = "^\\d{2}:\\d{2}") %>% ms()
```

```{r}
#The majority of times are recorded as H M S but are still class Char
test_1_M <- Mdat %>% #starts with 0
   filter(str_detect(Time, "^0")) %>% select(Time,rowname) 
test_2_M <- Mdat %>% #starts with 1
   filter(str_detect(Time, "^1")) %>% select(Time,rowname) 
test_3_M <- Mdat %>% #starts with 2
   filter(str_detect(Time, "^2")) %>% select(Time,rowname) 
test_complete_M <- rbind(test_1_M,test_2_M,test_3_M)
test_complete_M$Time <- test_complete_M$Time %>% str_extract(pattern = "^\\d{1}:\\d{2}:\\d{2}") %>%  #\d match any char with cat. number decimal digit
  hms()
test_complete_M <- rbind(test_complete_M,starts_5_M,starts_4_M)
```

```{r}
#Join all of these together. Note the new column is Time.y
Mdat <- left_join(Mdat,test_complete_M, by="rowname")
Mdat
```

```{r}
#Change time to minutes
Mdat$Time.y <- period_to_seconds(Mdat$Time.y)/60
Mdat
```


```{r}
#Client said max time was 2h20m although some were recorded as being more than that, so to keep
#things consistent I will remove all of those times not less than 2h20m
Wdat <- Wdat[Wdat$Time.y < 140,]
Mdat <- Mdat[Mdat$Time.y < 140,]
```




```{r}
#Cleaning up the ages
Wdat <- Wdat %>% 
  filter(!is.na(Wdat$Age) & Race <= 2019) #client wants races from before 2020
Wdat$Age <- as.numeric(Wdat$Age)
Wdat <- Wdat[Wdat$Age >= 12,] #To protect against some ages being obviously entered in error (i.e. age 2) I'm going to remove ages below 12 from both sets of data

Mdat <- Mdat %>% 
  filter(!is.na(Mdat$Age) & Race <= 2019)
Mdat$Age <- as.numeric(Mdat$Age)
Mdat <- Mdat[Mdat$Age >= 12,]

```

```{r}
#creating a df with both sets of data (Male and Female)
Wdat <- arrange(Wdat, Race)
Mdat <- arrange(Mdat, Race)

#Add column indicating sex to make it clearer in all_data
Wdat <- Wdat %>% mutate(sex = "W")
Mdat <- Mdat %>% mutate(sex = "M")

Wdat <- Wdat[,-c(5,6,9)] #Remove unwanted columns
Mdat <- Mdat[,-c(5,6,9)]

Wdat$Race <- as.factor(Wdat$Race) #this is a factor not a number
Mdat$Race <- as.factor(Mdat$Race) #this is a factor not a number
```


```{r}
#2015 Serena Burla was the top female racer but 5 women are listed as running faster
to_remove_W <- c(779,780,781,782,783)
Wdat = Wdat[!Wdat$rowname%in%to_remove_W,]
```


```{r}
Mdat %>% filter(Race == "1974") %>% arrange(Time.y) %>% select(Time.y)
Wdat %>% filter(Race == "2019") %>% arrange(Time.y) %>% select(Time.y)
```






```{r}
all_data <- rbind(Wdat,Mdat)
all_data <- arrange(all_data,Race)

```








```{r}
load("cts_per_yeargender.Rdata")

ct_yrsex <- ct_yrsex[which(ct_yrsex$sex != "NA"), ]
ct_yrsex %>% filter(Year <= 2019) %>% 
ggplot(aes(x = Year, y = n))+
  geom_line(aes(color = factor(sex)))+
  scale_x_discrete(limits = c(1973:2019))+
  guides( color = guide_legend(title = "SEX"))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  ylab("Number of People")+
  labs(title = "Number of People in Each Year")
```
```{r}
age_group = case_when(wdat$Age <= 10 ~ "Age<=10", wdat$Age > 10 & wdat$Age <=20 ~ "10 < Age <= 20", wdat$Age > 20 & wdat$Age <=30 ~ "20 < Age <= 30", wdat$Age > 30 & wdat$Age <=40 ~ "30 < Age <= 40", wdat$Age > 40 & wdat$Age<=50 ~ "40 < Age <= 50", wdat$Age > 50 & wdat$Age <= 60 ~ "50 < Age <= 60",wdat$Age > 60 & wdat$Age <= 70 ~ "60 < Age <= 70",wdat$Age > 70 & wdat$Age <=80 ~ "70 < Age <= 80", wdat$Age > 80 ~ "Age > 80")

wdat  = wdat %>% mutate(age_group)

ggplot(wdat, aes(x = Race, fill = age_group))+
  geom_bar(position = "dodge")+ 
  scale_x_discrete(limits = c(1974:2019))+
  scale_fill_discrete(name = "Age Group")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  xlab("Year")+
  ylab("Count")+
  labs(title = "Range of Age in each Year for all Women")
```
```{r}
age_group = case_when(mdat$Age <= 10 ~ "Age<=10", mdat$Age > 10 & mdat$Age <=20 ~ "10 < Age <= 20", mdat$Age > 20 & mdat$Age <=30 ~ "20 < Age <= 30", mdat$Age > 30 & mdat$Age <=40 ~ "30 < Age <= 40", mdat$Age > 40 & mdat$Age<=50 ~ "40 < Age <= 50", mdat$Age > 50 & mdat$Age <= 60 ~ "50 < Age <= 60",mdat$Age > 60 & mdat$Age <= 70 ~ "60 < Age <= 70",mdat$Age > 70 & mdat$Age <=80 ~ "70 < Age <= 80", mdat$Age > 80 ~ "Age > 80")

mdat  = mdat %>% mutate(age_group)

ggplot(mdat, aes(x = Race, fill = age_group))+
  geom_bar(position = "dodge")+ 
  scale_x_discrete(limits = c(1973:2019))+
  scale_fill_discrete(name = "Age Group")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  xlab("Year")+
  ylab("Count")+
  labs(title = "Range of Age in each Year for all Men")
```
```{r}
all_data <- rbind(wdat,mdat)
```
```{r}
all_data <- all_data %>% mutate(sex = (
strsplit(all_data$Division,"") %>% sapply( "[", 1 )))
all_data %>% filter(Time <2000) %>% 
ggplot(aes(fill = sex, colour = sex, group = sex))+
  geom_point(aes(x = Age, y = Time))+
  geom_smooth(aes(x = Age, y = Time))

```


```{r}
df_cleantown <- wdat[which(wdat$Hometown != "NR"), ]

df_cleantown$Hometown <- df_cleantown$Hometown %>% strsplit( ", " ) %>% sapply( "[", 1 )
df_cleantown <- df_cleantown %>% 
  filter(!is.na(df_cleantown$Hometown))

df_cleantown
```

```{r}
df_cleantown$Hometown <- tolower(df_cleantown$Hometown) #Returns the lowercase string.

all_states<-map_data("state")


ggplot() +
  geom_polygon(data = all_states, aes( x = long, y = lat, group = group), fill="white", color="grey") +
  theme_void() +
  coord_map()

all_states = all_states %>%
  right_join(. , df_cleantown, by=c("region" ="Hometown"))
all_states <- arrange(all_states, Race)

all_states <- all_states %>% 
  filter(!is.na(all_states$long))
all_states

ggplot() +
  geom_polygon(data = all_states, aes( x = long, y = lat, group = group)) +
  theme_void() +
  coord_map()
```















```{r}
library(usmap)
states <- data.frame(df_cleantown$Hometown)

plot_usmap(regions = "states", labels = TRUE)+
  labs(title = "U.S. States",
       subtitle = "This is a blank map of the United States.") + 
  theme(panel.background=element_blank()) 
  
```

```{r}
#library(broom)
#spdf_fortified <- tidy(df_cleantown$Hometown)

#ggplot()+
#  geom_polygon(df_cleantown$Hometown)
```






```{r}
weather = readr::read_csv("3139946.csv") #Loading the weather data and named it as data
head(weather) #seeing the first six rows of the data
```



```{r}
#dates of all the races in consideration
race_dates <- c('1973/04/01', '1974/03/31', '1975/04/06', '1976/04/04', '1977/04/03', '1978/04/02', '1979/04/01', '1980/03/30', '1981/04/05', '1982/04/04', '1983/03/27', '1984/04/01', '1985/03/31', '1986/04/06', '1987/04/05', '1988/03/27', '1989/04/02', '1990/04/01', '1991/03/31', '1992/04/05', '1993/04/04', '1994/04/10', '1995/04/09', '1996/03/31', '1997/04/06', '1998/04/05', '1999/04/11', '2000/04/09', '2001/04/08', '2002/04/07', '2003/04/06', '2004/04/04', '2005/04/03', '2006/04/02', '2007/04/01', '2008/04/06', '2009/04/05', '2010/04/11', '2011/04/03', '2012/04/01', '2013/04/07', '2014/04/06' ,'2015/04/12', '2016/04/03', '2017/04/02', '2018/04/07', '2019/04/07')

race_dates=as.Date(race_dates, "%Y/%m/%d") #convert to data objects
dates = c(1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019) #create vector of year 
dates.df = data.frame(race_dates,dates) #create new data frame with Date and Year
colnames(dates.df) = c('DATE','Race')
dates.df$Race <- as.factor(dates.df$Race)
```


```{r}
#using left join to add the year of races to the cherry blossom data frame
data_join_Race = all_data %>% left_join(dates.df, by = "Race")
head(data_join_Race)
```

```{r}
#using right join to add PRCP and TMIN columns from weather data frame to the cherry blossom data frame by the Date.
data_w <- weather %>% select(DATE, PRCP, TMIN) %>% 
  right_join(data_join_Race, by = "DATE")
data_w <- data_w %>%  drop_na() #drop all NAs
head(data_w)
```

```{r}
by_year_sex<- data_w %>%
  group_by(sex, DATE) %>%
  summarize(mediantime = median(Time.y))

# Plot the change in medianGdpPercap in each continent over time
ggplot(by_year_sex, aes(x = DATE, y = mediantime, color = sex)) +
  geom_line() +
  expand_limits(y = 0)+
  xlab("Dates of races")+
  ylab("Median Race Time (Minutes)")+
  ggtitle(label="Median race times over the years",subtitle = "In 2015 the course was only 9.39 miles")
```


```{r}
test_data = data_w

```


```{r}
model_1 <- lm(Time.y~0+Age,data = test_data)
summary(model_1)
```

Age is a significant predictor of race time. 


```{r}
model_2 <- lm(Time.y~0+sex,data = test_data)
summary(model_2)
```


sex is a significant predictor of race time.


```{r}
model_3 <- lm(Time.y~PRCP,data = test_data)
summary(model_3)
```

PRCP is significant predictor but the Adj R-sq is low, as would be expected




```{r}
model_4 <- lm(Time.y~0+Division,data = test_data)
summary(model_4)
```

All of the divisions are significant predictors of race time. 



```{r}
model_5 <- lm(Time.y~TMIN,data = test_data)
summary(model_5)
```

TMIN is a significant predictor of race times. 



```{r}
model_6 <- lm(Time.y~0+Race,data = test_data)
summary(model_6)
```

Race year is a shockingly good predictor of race times. I don't know why. 


```{r}
model_7 <- lm(Time.y~0+Age+sex,data = data_w)
summary(model_7)
```





```{r}
library(MASS)

boxcoxResult = boxcox(Time.y ~ 0+Age+sex, data =data_w, lambda = seq(-2,5,1.5))
```

```{r}
lambda = boxcoxResult$x[which.max(boxcoxResult$y)]
data_w$yboxcox = (data_w$Time.y^lambda-1)/lambda
model.boxcox = lm(yboxcox ~ 0+Age+sex,data = data_w)

summary(model.boxcox)
```

```{r}
plot(model.boxcox)
```

```{r}
broom::glance(model.boxcox)
```






```{r}
library(car)
confidenceEllipse(model.boxcox)
```

```{r}
ols_plot_resid_stud(model.boxcox)
```






```{r}
#just men's data
boxcoxResult_M = boxcox(Time.y ~ Age, data =Mdat, lambda = seq(-2,5,1.5))
lambda_M = boxcoxResult_M$x[which.max(boxcoxResult_M$y)]
Mdat$yboxcox = (Mdat$Time.y^lambda_M-1)/lambda_M
model.boxcox_M = lm(yboxcox ~ 0+Age,data = Mdat)

summary(model.boxcox_M)
```




```{r}
#plot predicted vs. actual values
plot(x=predict(model.boxcox_M), y=Mdat$Time.y,
     xlab='Predicted Values',
     ylab='Actual Values',
     main='Predicted vs. Actual Values')

#add diagonal line for estimated regression line
abline(a=0, b=1)
```











