---
title: "cherryB"
author: "Mina Mehdinia, Justin Valentine, Michael Wells"
date: "2022-10-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rvest)
library(stringr)
library(tidyverse)
library(lubridate)
library(dplyr)
library(ggplot2)
#install.packages("plotly")
#devtools::install_github("dtkaplan/statisticalModeling")
#library(devtools)
library(statisticalModeling)
library(olsrr)
library(scatterplot3d)
library(plotly)
```

```{r}
Wdata <-  read.csv("newdata.csv")
Mdata <- read.csv("mendataclean.csv")
```

```{r}
#Removing the year 2015 since the race was only 9.39 miles that year
#Pandemic years are also not included as per request from client.
Wdat = Wdata %>% filter(Race != 2015 & Race <= 2019)
Mdat = Mdata %>% filter(Race != 2015 & Race <= 2019)
```




```{r}
Wdat = Wdat[(!is.na(Wdata$Time)),] #removing NA in Time observation
Wdat <- Wdat %>% filter(Time != "") #removing unrecorded values
Wdat <- Wdat %>% filter(Time != "NR") #removing NR
Wdat <- add_rownames(Wdat) #necessary for indexing
```

```{r}
Mdat = Mdat[(!is.na(Mdata$Time)),] #removing NA in Time observation
Mdat <- Mdat %>% filter(Time != "") #removing unrecorded values
Mdat <- Mdat %>% filter(Time != "NR") #removing NR
Mdat <- add_rownames(Mdat) #necessary for indexing

#Mdat %>% filter(Time == "0.069664352")
#rows 4625,6428,102353  have crazy decimals
#times of "0.044872685"   "0.047581019"   "0.069664352"
rowname_bad_times <- c(4625,6428,102353)
Mdat <- Mdat[!Mdat$rowname%in%rowname_bad_times,]
```


```{r}
#Need to remove all the times starting with a 3 because they are either recorded in error
#i.e. time of 36:47:00 or beyond the limit of 2h20m
rowname_3s_W <- Wdat %>% 
   filter(str_detect(Time, "^3")) %>% dplyr::select(rowname)
rowname_3s_W <- as.numeric(rowname_3s_W$rowname)
Wdat <- Wdat[!Wdat$rowname%in%rowname_3s_W,]
```

```{r}
#Need to remove all the times starting with a 3 because they are either recorded in error
#i.e. time of 36:47:00 or beyond the limit of 2h20m
rowname_3s_M <- Mdat %>% 
   filter(str_detect(Time, "^3")) %>% dplyr::select(rowname)

rowname_3s_M <- as.numeric(rowname_3s_M$rowname)

Mdat <- Mdat[!Mdat$rowname%in%rowname_3s_M,]
```


```{r}
#Find all the times that are in the format of M:S:00 and change class to Time
#This is necessary otherwise they will be recorded as a race time of >50 hours etc
starts_5 <- Wdat %>% 
   filter(str_detect(Time, "^5")) %>% select(Time,rowname) 
starts_5$Time <- starts_5$Time %>% str_extract(pattern = "^\\d{2}:\\d{2}") %>% ms()

starts_4 <- Wdat %>% 
   filter(str_detect(Time, "^4")) %>% select(Time,rowname) 
starts_4$Time <- starts_4$Time %>% str_extract(pattern = "^\\d{2}:\\d{2}") %>% ms()
```

```{r}
#The majority of times are recorded as H M S but are still class Char
test_1 <- Wdat %>% #starts with 0
   filter(str_detect(Time, "^0")) %>% select(Time,rowname) 
test_2 <- Wdat %>% #starts with 1
   filter(str_detect(Time, "^1")) %>% select(Time,rowname) 
test_3 <- Wdat %>% #starts with 2
   filter(str_detect(Time, "^2")) %>% select(Time,rowname) 
test_complete <- rbind(test_1,test_2,test_3)
test_complete$Time <- test_complete$Time %>% str_extract(pattern = "^\\d{1}:\\d{2}:\\d{2}") %>%  #\d match any char with cat. number decimal digit
  hms()
test_complete <- rbind(test_complete,starts_5,starts_4)
```

```{r}
#Join all of these together. Note the new column is Time.y
Wdat <- left_join(Wdat,test_complete, by="rowname")
Wdat
```

```{r}
#Change time to minutes
Wdat$Time.y <- period_to_seconds(Wdat$Time.y)/60
Wdat
```

The women's times are cleaned, below we will clean the men's times.

```{r}
#Find all the times that are in the format of M:S:00 and change class to Time
#This is necessary otherwise they will be recorded as a race time of >50 hours etc
starts_5_M <- Mdat %>% 
   filter(str_detect(Time, "^5")) %>% select(Time,rowname) 
starts_5_M$Time <- starts_5_M$Time %>% str_extract(pattern = "^\\d{2}:\\d{2}") %>% ms()

starts_4_M <- Mdat %>% 
   filter(str_detect(Time, "^4")) %>% select(Time,rowname) 
starts_4_M$Time <- starts_4_M$Time %>% str_extract(pattern = "^\\d{2}:\\d{2}") %>% ms()
```

```{r}
#The majority of times are recorded as H M S but are still class Char
test_1_M <- Mdat %>% #starts with 0
   filter(str_detect(Time, "^0")) %>% select(Time,rowname) 
test_2_M <- Mdat %>% #starts with 1
   filter(str_detect(Time, "^1")) %>% select(Time,rowname) 
test_3_M <- Mdat %>% #starts with 2
   filter(str_detect(Time, "^2")) %>% select(Time,rowname) 
test_complete_M <- rbind(test_1_M,test_2_M,test_3_M)
test_complete_M$Time <- test_complete_M$Time %>% str_extract(pattern = "^\\d{1}:\\d{2}:\\d{2}") %>%  #\d match any char with cat. number decimal digit
  hms()
test_complete_M <- rbind(test_complete_M,starts_5_M,starts_4_M)
```

```{r}
#Join all of these together. Note the new column is Time.y
Mdat <- left_join(Mdat,test_complete_M, by="rowname")
Mdat
```

```{r}
#Change time to minutes
Mdat$Time.y <- period_to_seconds(Mdat$Time.y)/60
Mdat
```


```{r}
#Client said max time was 2h20m although some were recorded as being more than that, so to keep
#things consistent I will remove all of those times not less than 2h20m
Wdat <- Wdat[Wdat$Time.y < 140,]
Mdat <- Mdat[Mdat$Time.y < 140,]
```

At this point the times are cleaned for both sexes.

```{r}
#Add column indicating sex to make it clearer in all_data
Wdat <- Wdat %>% mutate(sex = "W")
Mdat <- Mdat %>% mutate(sex = "M")
#creating a df with both sets of data (Male and Female)
all_data <- rbind(Wdat,Mdat)
all_data <- arrange(all_data,Race)
```


```{r}
#Putting this plot here to see times including year 1973 which we remove later on for only having 2 data values with Age, but Age was not a part of this plot.
by_year_sex<- all_data %>%
  group_by(sex, Race) %>%
  summarize(mediantime = median(Time.y))
```



```{r}
# Plot the change in medianGdpPercap in each continent over time
ggplot(by_year_sex, aes(x = Race, y = mediantime, color = sex)) +
  geom_line() +
  expand_limits(y = 0)+
  xlab("Date of race")+
  ylab("Median Race Time (Minutes)")+
  ggtitle(label="Median race times over the years", subtitle= "Very few run times for women pre-1979 causing instability in the graph for those years")
```








```{r}
Wdat = Wdat %>% filter(Race != 1973)
Mdat = Mdat %>% filter(Race != 1973) #too few observations with Age records

#Cleaning up the ages
Wdat <- Wdat %>% 
  filter(!is.na(Wdat$Age) & Age != "NR")
Wdat$Age <- as.numeric(Wdat$Age)
Wdat <- Wdat[Wdat$Age >= 9,] #To protect against some ages being obviously entered in error (i.e. age 2) I'm going to remove ages below 12 from both sets of data

Mdat <- Mdat %>% 
  filter(!is.na(Mdat$Age) & Age != "NR")
Mdat$Age <- as.numeric(Mdat$Age)
Mdat <- Mdat[Mdat$Age >= 9,]
```

```{r}
Wdat <- arrange(Wdat, Race)
Mdat <- arrange(Mdat, Race)


Wdat <- Wdat[,-c(5,6,9)] #Remove unwanted columns
Mdat <- Mdat[,-c(5,6,9)]
```



```{r}
#creating a df with both sets of data (Male and Female)
all_data <- rbind(Wdat,Mdat)
all_data <- arrange(all_data,Race)

all_data$Race <- as.factor(all_data$Race)
```





```{r}
all_data %>% ggplot(aes(fill = sex, colour = sex, group = sex))+
  geom_point(aes(x = Age, y = Time.y ),size= 0.2)+
  geom_smooth(aes(x = Age, y = Time.y))+
  ggtitle("Age vs Time")+
  ylab("Time in Minutes")
```

```{r}
df_cleantown <- all_data[which(all_data$Hometown != "NR"), ]

df_cleantown$Hometown <- df_cleantown$Hometown %>% strsplit( ", " ) %>% sapply( "[", 2 )
df_cleantown <- df_cleantown %>% 
  filter(!is.na(df_cleantown$Hometown))

df_cleantown$Hometown <- toupper(df_cleantown$Hometown) #Returns the lowercase string.

df_cleantown$Hometown[(df_cleantown$Hometown == "D.C")] = "DC" 
df_cleantown$Hometown[(df_cleantown$Hometown == "D.C.")] = "DC" 
df_cleantown$Hometown[(df_cleantown$Hometown == "DISTRICT OF COLUMBI")] = "DC" 
df_cleantown$Hometown[(df_cleantown$Hometown == "NEW YORK")] = "NY" 
df_cleantown$Hometown[(df_cleantown$Hometown == "VIRGINIA")] = "VA" 
df_cleantown$Hometown[(df_cleantown$Hometown == " VA  22033")] = "VA" 



all_states<-map_data("state")
all_states$abb <- state.abb[match(all_states$region,tolower(state.name))]
all_states[is.na(all_states$abb),] = "DC"
state.dataframe <- unique(all_states$abb)


df_cleantown <- df_cleantown[(df_cleantown$Hometown%in%all_states$abb),] 

all_states <- all_states[,-c(4,5,6)] #Remove unwanted columns

comb_all_states <- all_states %>%
  right_join(df_cleantown, by=c("abb" ="Hometown"))

#all_states <- arrange(all_states, Race)

all_states <- all_states %>% 
  filter(!is.na(all_states$long))
all_states

all_states$abb <- state.abb[match(all_states$region,tolower(state.name))]
unique(all_states$abb)
```


```{r}
all_states %>% group_by(region) %>% 
  summarise(count = n())
```


```{r}
df_cleantown %>% group_by(Hometown) %>% 
  summarise(count = n())
```
```{r}
unique(df_cleantown$Hometown)
```


















```{r}
load("cts_per_yeargender.Rdata")

ct_yrsex <- ct_yrsex[which(ct_yrsex$sex != "NA"), ]
ct_yrsex %>% filter(Year <= 2019) %>% 
ggplot(aes(x = Year, y = n))+
  geom_line(aes(color = factor(sex)))+
  scale_x_discrete(limits = c(1973:2019))+
  guides( color = guide_legend(title = "SEX"))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  ylab("Number of People")+
  labs(title = "Number of People in Each Year")
```

```{r}
age_group = case_when(wdat$Age <= 10 ~ "Age<=10", wdat$Age > 10 & wdat$Age <=20 ~ "10 < Age <= 20", wdat$Age > 20 & wdat$Age <=30 ~ "20 < Age <= 30", wdat$Age > 30 & wdat$Age <=40 ~ "30 < Age <= 40", wdat$Age > 40 & wdat$Age<=50 ~ "40 < Age <= 50", wdat$Age > 50 & wdat$Age <= 60 ~ "50 < Age <= 60",wdat$Age > 60 & wdat$Age <= 70 ~ "60 < Age <= 70",wdat$Age > 70 & wdat$Age <=80 ~ "70 < Age <= 80", wdat$Age > 80 ~ "Age > 80")

wdat  = wdat %>% mutate(age_group)

ggplot(wdat, aes(x = Race, fill = age_group))+
  geom_bar(position = "dodge")+ 
  scale_x_discrete(limits = c(1974:2019))+
  scale_fill_discrete(name = "Age Group")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  xlab("Year")+
  ylab("Count")+
  labs(title = "Range of Ages in each Year for all Women")
```

```{r}
age_group = case_when(mdat$Age <= 10 ~ "Age<=10", mdat$Age > 10 & mdat$Age <=20 ~ "10 < Age <= 20", mdat$Age > 20 & mdat$Age <=30 ~ "20 < Age <= 30", mdat$Age > 30 & mdat$Age <=40 ~ "30 < Age <= 40", mdat$Age > 40 & mdat$Age<=50 ~ "40 < Age <= 50", mdat$Age > 50 & mdat$Age <= 60 ~ "50 < Age <= 60",mdat$Age > 60 & mdat$Age <= 70 ~ "60 < Age <= 70",mdat$Age > 70 & mdat$Age <=80 ~ "70 < Age <= 80", mdat$Age > 80 ~ "Age > 80")

mdat  = mdat %>% mutate(age_group)

ggplot(mdat, aes(x = Race, fill = age_group))+
  geom_bar(position = "dodge")+ 
  scale_x_discrete(limits = c(1973:2019))+
  scale_fill_discrete(name = "Age Group")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  xlab("Year")+
  ylab("Count")+
  labs(title = "Range of Ages in each Year for all Men")
```





```{r}
df_cleantown$Hometown <- tolower(df_cleantown$Hometown) #Returns the lowercase string.

all_states<-map_data("state")


ggplot() +
  geom_polygon(data = all_states, aes( x = long, y = lat, group = group), fill="white", color="grey") +
  theme_void() +
  coord_map()

all_states = all_states %>%
  right_join(. , df_cleantown, by=c("region" ="Hometown"))
all_states <- arrange(all_states, Race)

all_states <- all_states %>% 
  filter(!is.na(all_states$long))
all_states

ggplot() +
  geom_polygon(data = all_states, aes( x = long, y = lat, group = group)) +
  theme_void() +
  coord_map()
```





```{r}
library(usmap)
states <- data.frame(df_cleantown$Hometown)

plot_usmap(regions = "states", labels = TRUE)+
  labs(title = "U.S. States",
       subtitle = "This is a blank map of the United States.") + 
  theme(panel.background=element_blank()) 
  
```

```{r}
#library(broom)
#spdf_fortified <- tidy(df_cleantown$Hometown)

#ggplot()+
#  geom_polygon(df_cleantown$Hometown)
```






```{r}
weather = readr::read_csv("3139946.csv") #Loading the weather data and named it as data
head(weather) #seeing the first six rows of the data
```



```{r}
#dates of all the races in consideration
race_dates <- c('1973/04/01', '1974/03/31', '1975/04/06', '1976/04/04', '1977/04/03', '1978/04/02', '1979/04/01', '1980/03/30', '1981/04/05', '1982/04/04', '1983/03/27', '1984/04/01', '1985/03/31', '1986/04/06', '1987/04/05', '1988/03/27', '1989/04/02', '1990/04/01', '1991/03/31', '1992/04/05', '1993/04/04', '1994/04/10', '1995/04/09', '1996/03/31', '1997/04/06', '1998/04/05', '1999/04/11', '2000/04/09', '2001/04/08', '2002/04/07', '2003/04/06', '2004/04/04', '2005/04/03', '2006/04/02', '2007/04/01', '2008/04/06', '2009/04/05', '2010/04/11', '2011/04/03', '2012/04/01', '2013/04/07', '2014/04/06' ,'2015/04/12', '2016/04/03', '2017/04/02', '2018/04/07', '2019/04/07')

race_dates=as.Date(race_dates, "%Y/%m/%d") #convert to data objects
dates = c(1973,1974,1975,1976,1977,1978,1979,1980,1981,1982,1983,1984,1985,1986,1987,1988,1989,1990,1991,1992,1993,1994,1995,1996,1997,1998,1999,2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016,2017,2018,2019) #create vector of year 
dates.df = data.frame(race_dates,dates) #create new data frame with Date and Year
colnames(dates.df) = c('DATE','Race')
dates.df$Race <- as.factor(dates.df$Race)
```


```{r}
#using left join to add the year of races to the cherry blossom data frame
data_join_Race = all_data %>% left_join(dates.df, by = "Race")
head(data_join_Race)
```

```{r}
#using right join to add PRCP and TMIN columns from weather data frame to the cherry blossom data frame by the Date.
data_w <- weather %>% select(DATE, PRCP, TMIN) %>% 
  right_join(data_join_Race, by = "DATE")
data_w <- data_w %>%  drop_na() #drop all NAs
head(data_w)
```
















```{r}


model.log = lm(log(Time.y)~poly(Age,3)*sex+PRCP+TMIN, data = data_w)

summary(model.log)
```


```{r}
fmodel(model.log, ~ TMIN + sex + Age, nlevels = 3, intervals = "prediction", post_transform = c(Time.y = exp))
```



```{r}
plot(model.log)
```


```{r}
fmodel(model.log, ~ Age + sex + PRCP, nlevels = 12, intervals = "prediction")
```


```{r}
fmodel(lin_model_2, ~ Age + sex + TMIN, nlevels = 3, intervals = "prediction")
```


```{r}
hist(model.log$residuals)
```


```{r}
library(car)
confidenceEllipse(model.log)
```

```{r}
library(cluster)    # clustering algorithms
library(factoextra) # clustering visualization
library(dendextend) # for comparing two dendrograms
```


```{r}
#head(df_cleantown)

df_cluster <- data.frame(df_cleantown$Age,df_cleantown$Time.y)
#standardize
#column_to_rownames(df_cluster)
#column_to_rownames(df_cluster, 'Hometown')
df_cluster$df_cleantown.Age <- scale(df_cluster$df_cleantown.Age)
df_cluster$df_cleantown.Time.y <- scale(df_cluster$df_cleantown.Time.y)
df_cluster
```








```{r}
cluster_sample <- df_cluster[sample(nrow(df_cluster),100),]
cluster_sample$df_cleantown.Age <- scale(cluster_sample$df_cleantown.Age)
cluster_sample$df_cleantown.Time.y<- scale(cluster_sample$df_cleantown.Time.y)
cluster_sample


#column_to_rownames(cluster_sample)
#column_to_rownames(df_cluster, 'df_cleantown.Hometown')
```



```{r}
# Compute with agnes
hc2 <- agnes(cluster_sample, method = "complete")

# Agglomerative coefficient
hc2$ac
```

```{r}
# Dissimilarity matrix
d <- dist(cluster_sample, method = "euclidean")
# Ward's method
hc5 <- hclust(d, method = "ward.D2" )

# Cut tree into 4 groups
sub_grp <- cutree(hc5, k = 4)

# Number of members in each cluster
table(sub_grp)
```
```{r}
cluster_sample %>%
  mutate(cluster = sub_grp) %>%
  head
```

```{r}
fviz_cluster(list(data = cluster_sample, cluster = sub_grp))
```





